== Azure Service Operator (ASO)

The Azure Service Operator (ASO) allows you to create and use Azure services directly from Kubernetes. You can deploy your applications, including any required Azure services directly within the Kubernetes framework using a familiar structure to declaratively define and create Azure services like Storage Blob or CosmosDB databases.

In order to illustrate the use of the ASO on ARO, we will walk through a simple example of creating an Azure Blob Storage container, connecting to it with OSToy, upload a file to it, and view the file in our application. Interestingly, this part of the workshop will also use Azure Key Vault to store secrets that the application can use to access Azure services. We will store the secret needed to access the Blob Storage in Azure Key Vault and then mount the secret from there into our cluster for the OSToy application to use.

=== Why should you use Key Vault to store secrets?

Using a secret store like Azure Key Vault allows you to take advantage of a number of benefits.

. Scalability - Using a secret store service is already designed to scale to handle a large number of secrets over placing them directly in the cluster.
. Centralization - You are able to keep all your organizations secrets in one location.
. Security - Features like access control, monitoring, encryption and audit are already baked in.
. Rotation - Decoupling the secret from your cluster makes it much easier to rotate secrets since you only have to update it in Key Vault and the Kubernetes secret in the cluster will reference that external secret store.

=== Section overview

To make the process clearer, here is an overview of the procedure we are going to follow. There are three main "parts".

. *Install the Azure Service Operator* - This allows you to create/delete blob storage through the use of a Kubernetes Custom Resource. Install the controller which will also create the required namespace and the service account and then create the required resources.
. *Setup Key Vault* - Perform required prerequisites (ex: install CSI drivers), create a Key Vault instance, add the connection string.
. *Application access* - configuring the application to access the stored connection string in Key Vault and thus enable the application to access the Blob Storage location.

Below is an updated application diagram of what this will look like after completing this section.

image::images/49-newarch.png

== Access the cluster

. Login to the cluster using the `oc` CLI if you are not already logged in.

== Setup

=== Define helper variables

. Set helper environment variables to facilitate execution of the commands in this section.
+
[source,sh,role=execute]
----
export AZURE_SUBSCRIPTION_ID=%azure_subscription_id%
export AZURE_TENANT_ID=%azure_tenant%
export AZURE_CLIENT_ID=%azappid%
export AZURE_CLIENT_SECRET=%azpass%
export PROJECT_NAME=ostoy-${GUID}
export KEYVAULT_NAME=secret-store-${GUID}
----

=== Install the Azure Service Operator

. We first need to install Cert Manager. Run the following:
+
[source,sh,role=execute]
----
oc apply -f https://github.com/jetstack/cert-manager/releases/download/v1.8.2/cert-manager.yaml
----

. Validate you have three pods running (wait until you do):
+
[source,sh,role=execute]
----
oc get pod -n cert-manager
----
+
.Sample Output
[source,text,options=nowrap]
----
NAME                                       READY   STATUS    RESTARTS   AGE
cert-manager-677874db78-t6wgn              1/1     Running   0          57m
cert-manager-cainjector-6c5bf7b759-l722b   1/1     Running   0          57m
cert-manager-webhook-5685fdbc4b-rlbhz      1/1     Running   0          57m
----

. Add a few Helm Repos:
+
[source,sh,role=execute]
----
# Azure Service Operator
helm repo add aso2 https://raw.githubusercontent.com/Azure/azure-service-operator/main/v2/charts

# Secrets Store CSI Driver
helm repo add secrets-store-csi-driver https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts

# Azure CSI Secrets Store Provider
helm repo add csi-secrets-store-provider-azure https://azure.github.io/secrets-store-csi-driver-provider-azure/charts

# Update local repo list
helm repo update
----

. Install Azure Service Operator:
+
[source,sh,role=execute]
----
helm upgrade --install --devel aso2 aso2/azure-service-operator \
  --create-namespace \
  --namespace=azureserviceoperator-system \
  --set azureSubscriptionID=$AZURE_SUBSCRIPTION_ID \
  --set azureTenantID=$AZURE_TENANT_ID \
  --set azureClientID=$AZURE_CLIENT_ID \
  --set azureClientSecret=$AZURE_CLIENT_SECRET
----

. Validate it is running:
+
[source,sh,role=execute]
----
oc project azureserviceoperator-system
oc get pod
----
+
.Sample Output
[source,text,options=nowrap]
----
NAME                                                       READY   STATUS    RESTARTS      AGE
azureserviceoperator-controller-manager-6c667599f6-pql98   2/2     Running   1 (55m ago)   56m
----

== Create Storage Accounts and containers using the ASO

Now we need to create a Storage Account and for our blob storage to use with OSToy.
We could create this using the CLI or the Azure Portal, but wouldn't it be nice if we could do so using standard Kubernetes objects.
We could define the all the resources our application needs in once place. We will create each resource separately below.

. Create a Resourcegroup
+
[source,sh,role=execute]
----
cat << EOF | oc apply -f -
---
apiVersion: resources.azure.com/v1api20200601
kind: ResourceGroup
metadata:
  name: openenv${GUID}
  namespace: ${PROJECT_NAME}-rg
spec:
  location: eastus
EOF
----

. Confirm that the Resource Group was actually created. You will see the name returned. It may take a minute or two to appear.
+
[source,sh,role=execute]
----
az group list --query '[].name' --output tsv | grep ${GUID}
----


. Create a Storage Account:
+
[source,sh,role=execute]
----
cat << EOF | oc apply -f -
---
apiVersion: storage.azure.com/v1api20210401
kind: StorageAccount
metadata:
  name: storage${GUID}
  namespace: ${PROJECT_NAME}
spec:
  location: eastus
  kind: BlobStorage
  sku:
    name: Standard_LRS
  owner:
    name: openenv-${GUID}
  accessTier: Hot
EOF
----

. Confirm that it was created. It may take a minute or two to appear.
+
[source,sh,role=execute]
----
az storage account list --query '[].name' --output tsv | grep ${GUID}
----

. Create a Blob Service:
+
[source,sh,role=execute]
----
cat << EOF | oc apply -f -
---
apiVersion: storage.azure.com/v1api20210401
kind: StorageAccountsBlobService
metadata:
  name: samplekubestorageservice
  namespace: ${PROJECT_NAME}
spec:
  owner:
    name: storage${GUID}
EOF
----

. Finally create a storage container:
+
[source,sh,role=execute]
----
cat << EOF | oc apply -f -
---
apiVersion: storage.azure.com/v1api20210401
kind: StorageAccountsBlobServicesContainer
metadata:
  name: samplecontainer
  namespace: ${PROJECT_NAME}
spec:
  owner:
    name: samplekubestorageservice
EOF
----

. Confirm that the container was created. It make take a minute or two to appear.
+
[source,sh,role=execute]
----
az storage container list --auth-mode login --account-name storage${GUID} --query '[].name' -o tsv
----

. Obtain the connection string of the Storage Account for use in the next section. The --name parameter is the name of the Storage Account we created using the ASO.
+
[source,sh,role=execute]
----
export CONNECTION_STRING=$(az storage account show-connection-string --name storage${GUID} --resource-group ${PROJECT_NAME}-rg -o tsv)
----

The storage account is now set up for use with our application.

== Install Kubernetes Secret Store CSI

== Keyvault

. Set some environment variables (or adjust the commands from the mobb ninja document to use the ones from above)
+
[source,sh,role=execute]
----
export KEYVAULT_RESOURCE_GROUP=openenv-${GUID}
export KEYVAULT_LOCATION=eastus
export KEYVAULT_NAME=secret-store-${GUID}
export AZ_TENANT_ID=$(az account show -o tsv --query tenantId)
----

. Then follow instructions at https://mobb.ninja/docs/misc/secrets-store-csi/azure-key-vault
