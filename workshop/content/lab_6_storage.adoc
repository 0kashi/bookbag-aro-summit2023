= Storage Stuff

Set environment variables:
+
[source,sh,role=execute]
----
export AZURE_SUBSCRIPTION_ID=%azure_subscription_id%
export AZURE_TENANT_ID=%azure_tenant%
export AZURE_CLIENT_ID=%aro_clientid%
export AZURE_CLIENT_SECRET=%azpass%
----

. Deploy cert manager:
+
[source,sh,role=execute]
----
oc apply -f https://github.com/jetstack/cert-manager/releases/download/v1.8.2/cert-manager.yaml
----

. Validate you have three pods running (wait until you do):
+
[source,sh,role=execute]
----
oc get pod -n cert-manager
----
+
.Sample Output
[source,text,options=nowrap]
----
NAME                                       READY   STATUS    RESTARTS   AGE
cert-manager-677874db78-t6wgn              1/1     Running   0          57m
cert-manager-cainjector-6c5bf7b759-l722b   1/1     Running   0          57m
cert-manager-webhook-5685fdbc4b-rlbhz      1/1     Running   0          57m
----

. Add a few Helm Repos:
+
[source,sh,role=execute]
----
# Azure Service Operator
helm repo add aso2 https://raw.githubusercontent.com/Azure/azure-service-operator/main/v2/charts


# Update local repo list
helm repo update
----

. Install Azure Service Operator:
+
[source,sh,role=execute]
----
helm upgrade --install --devel aso2 aso2/azure-service-operator \
  --create-namespace \
  --namespace=azureserviceoperator-system \
  --set azureSubscriptionID=$AZURE_SUBSCRIPTION_ID \
  --set azureTenantID=$AZURE_TENANT_ID \
  --set azureClientID=$AZURE_CLIENT_ID \
  --set azureClientSecret=$AZURE_CLIENT_SECRET
----

. Validate it's running:
+
[source,sh,role=execute]
----
oc project azureserviceoperator-system
oc get pod
----
+
.Sample Output
[source,text,options=nowrap]
----
NAME                                                       READY   STATUS    RESTARTS      AGE
azureserviceoperator-controller-manager-6c667599f6-pql98   2/2     Running   1 (55m ago)   56m
----

. Create a Resourcegroup
+
[source,sh,role=execute]
----
cat << EOF | oc apply -f -
---
apiVersion: resources.azure.com/v1api20200601
kind: ResourceGroup
metadata:
  name: openenv${GUID}
  namespace: ostoy
spec:
  location: eastus
EOF
----

. Create a Storage Account:
+
[source,sh,role=execute]
----
cat << EOF | oc apply -f -
---
apiVersion: storage.azure.com/v1api20210401
kind: StorageAccount
metadata:
  name: storage${GUID}
  namespace: ostoy
spec:
  location: eastus
  kind: BlobStorage
  sku:
    name: Standard_LRS
  owner:
    name: openenv-${GUID}
  accessTier: Hot
EOF
----

. Create a Blob Service:
+
[source,sh,role=execute]
----
cat << EOF | oc apply -f -
---
apiVersion: storage.azure.com/v1api20210401
kind: StorageAccountsBlobService
metadata:
  name: samplekubestorageservice
  namespace: ostoy
spec:
  owner:
    name: storage${GUID}
EOF
----

. Finally create a storage container:
+
[source,sh,role=execute]
----
cat << EOF | oc apply -f -
---
apiVersion: storage.azure.com/v1api20210401
kind: StorageAccountsBlobServicesContainer
metadata:
  name: samplecontainer
  namespace: ostoy
spec:
  owner:
    name: samplekubestorageservice
EOF
----

== Keyvault

export KEYVAULT_RESOURCE_GROUP=openenv-${GUID}
export KEYVAULT_LOCATION=eastus
export KEYVAULT_NAME=secret-store-${GUID}
export AZ_TENANT_ID=$(az account show -o tsv --query tenantId)

Then follow instructions below.
https://mobb.ninja/docs/misc/secrets-store-csi/azure-key-vault/
